image:
  name: public.ecr.aws/dnxbrasil/pulumi:3.40.0
  entrypoint: ['']

services:
  - public.ecr.aws/docker/library/docker:19.03.14-dind

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_DRIVER: overlay2

stages:
  - plan
  - apply
  
# SHARED
plan-shared:
  stage: plan
  when: on_success
  tags: [teccoletor-infra-runner, docker]
  script:
    - output=$(aws sts assume-role --role-arn "arn:aws:iam::533120864749:role/InfraDeployAccess" --role-session-name SessionInfraDeployAccess)
    - export AWS_ACCESS_KEY_ID=$(echo $output | jq -r '.Credentials''.AccessKeyId')
    - export AWS_SECRET_ACCESS_KEY=$(echo $output | jq -r '.Credentials''.SecretAccessKey')
    - export AWS_SESSION_TOKEN=$(echo $output | jq -r '.Credentials''.SessionToken')  
    - npm install
    - pulumi stack select shared
    - pulumi preview 

apply-shared:
  stage: apply
  needs: ["plan-shared"]
  when: manual
  tags: [teccoletor-infra-runner, docker]
  script:
    - output=$(aws sts assume-role --role-arn "arn:aws:iam::533120864749:role/InfraDeployAccess" --role-session-name SessionInfraDeployAccess)
    - export AWS_ACCESS_KEY_ID=$(echo $output | jq -r '.Credentials''.AccessKeyId')
    - export AWS_SECRET_ACCESS_KEY=$(echo $output | jq -r '.Credentials''.SecretAccessKey')
    - export AWS_SESSION_TOKEN=$(echo $output | jq -r '.Credentials''.SessionToken')  
    - npm install
    - pulumi stack select shared
    - pulumi apply -y
